
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Convertir RPT a JSON</title>
</head>
<body>
  <h2>Convertidor de Catálogo .rpt a JSON</h2>
  <input type="file" id="fileInput" accept=".txt,.rpt"><br><br>
  <button onclick="convertirArchivo()">Convertir</button>
  <button id="descargarBtn" onclick="descargarJSON()" disabled>Descargar JSON</button>
  <pre id="salidaJson" style="white-space: pre-wrap; background: #eee; padding: 10px;"></pre>

  <script>
    let jsonGenerado = null;

    function convertirArchivo() {
      const archivo = document.getElementById('fileInput').files[0];
      if (!archivo) return alert("Selecciona un archivo primero");

      const lector = new FileReader();
      lector.onload = function (e) {
        const texto = e.target.result;
        const lineas = texto.split("\n");
        const articulos = [];

        const patron = /^\s*(\d+)\s+(\d+)\s+([0-9A-Z]+)\s+(.*?)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+¦\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)/;

        for (let linea of lineas) {
          const match = linea.match(patron);
          if (match) {
            articulos.push({
              departamento: parseInt(match[1]),
              linea: parseInt(match[2]),
              codigo: match[3],
              nombre: match[4].trim(),
              costo_ultimo: parseFloat(match[5]),
              precio_publico_matriz: parseFloat(match[6]),
              precio_mediamay_matriz: parseFloat(match[7]),
              precio_mayoreo_matriz: parseFloat(match[8]),
              precio_publico_sucursal: parseFloat(match[9]),
              precio_mediamay_sucursal: parseFloat(match[10]),
              precio_mayoreo_sucursal: parseFloat(match[11]),
            });
          }
        }

        jsonGenerado = articulos;
        document.getElementById('salidaJson').textContent = JSON.stringify(articulos, null, 2);
        document.getElementById('descargarBtn').disabled = false;
      };

      lector.readAsText(archivo, 'ISO-8859-1');
    }

    function descargarJSON() {
      if (!jsonGenerado) return;
      const blob = new Blob([JSON.stringify(jsonGenerado, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const enlace = document.createElement("a");
      enlace.href = url;
      enlace.download = "catalogo_articulos.json";
      enlace.click();

      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
